<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>uploader.erl</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>uploader.erl</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p>Provides parsing of multipart/form-data on the calling process
via callbacks which are chained based on previous or subsequent data.
Updates the registered process of <a href="progress.html">progress.erl</a> with upload statistics
each time a chunk of body data is parsed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">uploader</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;records.hrl&quot;</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h3>Starting:</h3>
<p>Passes a curried callback function and the incoming request to the <code>mochiweb_multipart</code>
module, which parses the incoming form-data boundary and fires the callback.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">start</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span> 
    <span class="nv">Callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">({</span><span class="n">file</span><span class="p">,</span> <span class="n">new_context</span><span class="p">(</span><span class="nv">Req</span><span class="p">)}),</span>
    <span class="nn">mochiweb_multipart</span><span class="p">:</span><span class="n">parse_multipart_request</span><span class="p">(</span><span class="nv">Req</span><span class="p">,</span> <span class="nv">Callback</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <h3>Internal:</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Each subsequent call of the callback wrapper should generate a new 
function to be applied when the next chunk is received.
<code>callback/1</code> partially applies the current context to a new function wrapper.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">callback</span><span class="p">(</span><span class="nv">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">fun</span><span class="p">(</span><span class="nv">Next</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callback</span><span class="p">(</span><span class="nv">Next</span><span class="p">,</span> <span class="nv">Context</span><span class="p">)</span> <span class="k">end</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>Runs the <code>parse/2</code> function patterns and wraps the result in 
using <code>callback/1</code> as the next callback to be fired by <code>mochiweb_multipart</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">callback</span><span class="p">(</span><span class="nv">Chunk</span><span class="p">,</span> <span class="nv">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">callback</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="nv">Chunk</span><span class="p">,</span> <span class="nv">Context</span><span class="p">)).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p><code>{headers, ...}</code> matches the start of a boundary</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">parse</span><span class="p">({</span><span class="n">headers</span><span class="p">,</span> <span class="nv">Headers</span><span class="p">},</span> <span class="p">{_</span><span class="nv">Any</span><span class="p">,</span> <span class="nv">Context</span><span class="p">})</span> <span class="o">-&gt;</span> <span class="n">headers</span><span class="p">(</span><span class="nv">Context</span><span class="p">,</span> <span class="nv">Headers</span><span class="p">);</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>Matches chunks of binary body <code>Data</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">parse</span><span class="p">({</span><span class="n">body</span><span class="p">,</span> <span class="nv">Data</span><span class="p">},</span> <span class="p">{</span><span class="nv">Field</span><span class="p">,</span> <span class="nv">Context</span><span class="p">})</span>      <span class="o">-&gt;</span> <span class="n">body</span><span class="p">(</span><span class="nv">Field</span><span class="p">,</span> <span class="nv">Context</span><span class="p">,</span> <span class="nv">Data</span><span class="p">);</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>The end of a form boundary.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">parse</span><span class="p">(</span><span class="n">body_end</span><span class="p">,</span> <span class="p">{</span><span class="nv">Field</span><span class="p">,</span> <span class="nv">Context</span><span class="p">})</span>          <span class="o">-&gt;</span> <span class="n">body_end</span><span class="p">(</span><span class="nv">Field</span><span class="p">,</span> <span class="nv">Context</span><span class="p">);</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>No more processing to be done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">parse</span><span class="p">(</span><span class="n">eof</span><span class="p">,</span> <span class="p">{_</span><span class="nv">Any</span><span class="p">,</span> <span class="nv">Context</span><span class="p">})</span>                <span class="o">-&gt;</span> <span class="n">save</span><span class="p">(</span><span class="nv">Context</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Matches the <code>content-disposition</code> header and returns a <code>tuple</code> which
signifies which pattern for <code>body/3</code> to apply.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">headers</span><span class="p">(</span><span class="nv">Context</span><span class="p">,</span> <span class="p">[</span><span class="nv">Disposition</span><span class="p">|_])</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nv">Disposition</span> <span class="k">of</span>
        <span class="p">{</span><span class="s">&quot;content-disposition&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;form-data&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="nv">Field</span><span class="p">}]}}</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="nb">list_to_atom</span><span class="p">(</span><span class="nv">Field</span><span class="p">),</span> <span class="nv">Context</span><span class="p">};</span>
        <span class="p">{</span><span class="s">&quot;content-disposition&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;form-data&quot;</span><span class="p">,</span> <span class="p">[{</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="p">_},</span> <span class="p">{</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="nv">Name</span><span class="p">}]}}</span> <span class="o">-&gt;</span>
            <span class="nv">Path</span> <span class="o">=</span> <span class="nn">config</span><span class="p">:</span><span class="n">tmp_path</span><span class="p">([</span><span class="nv">Context</span><span class="nl">#con.key</span><span class="p">]),</span>
            <span class="nn">filelib</span><span class="p">:</span><span class="n">ensure_dir</span><span class="p">(</span><span class="nv">Path</span><span class="p">),</span>           
            <span class="nv">Upload</span> <span class="o">=</span> <span class="nv">Context</span><span class="nl">#con.upload</span><span class="p">,</span>
            <span class="n">file_started</span><span class="p">(</span><span class="nv">Context</span><span class="nl">#con</span><span class="p">{</span><span class="n">path</span><span class="o">=</span><span class="nv">Path</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="nv">Upload</span><span class="nl">#upload</span><span class="p">{</span><span class="n">name</span><span class="o">=</span><span class="nv">Name</span><span class="p">}});</span>            
         <span class="p">_</span><span class="nv">Other</span> <span class="o">-&gt;</span>
            <span class="p">{</span><span class="n">unknown</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}</span>
    <span class="k">end</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>No <code>content-disposition</code> with a <code>filename</code> has been received.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">io</span><span class="o">=</span><span class="n">none</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">none</span><span class="p">},</span> <span class="p">_</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="p">};</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>A <code>content-disposition</code> header has been received, and a temporary path created,
start writing the first chunk of data or error if the temp file cannot be opened.
Notifies the progress monitor a new upload has started.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">io</span><span class="o">=</span><span class="n">none</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="nv">Path</span><span class="p">},</span> <span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">file</span><span class="p">:</span><span class="n">open</span><span class="p">(</span><span class="nv">Path</span><span class="p">,</span> <span class="p">[</span><span class="n">raw</span><span class="p">,</span> <span class="n">write</span><span class="p">])</span> <span class="k">of</span>
        <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">IO</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nn">file</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nv">IO</span><span class="p">,</span> <span class="nv">Data</span><span class="p">),</span>
            <span class="n">file_updated</span><span class="p">(</span><span class="nv">Context</span><span class="nl">#con</span><span class="p">{</span><span class="n">io</span><span class="o">=</span><span class="nv">IO</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="nb">size</span><span class="p">(</span><span class="nv">Data</span><span class="p">)});</span>
        <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Error</span><span class="p">}</span> <span class="o">-&gt;</span>
            <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="nv">Error</span><span class="p">,</span> <span class="s">&quot;can&#39;t open </span><span class="si">~p</span><span class="s"> for writing&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Path</span><span class="p">]),</span>
            <span class="nb">exit</span><span class="p">(</span><span class="n">could_not_open_file_for_writing</span><span class="p">),</span>
            <span class="p">{</span><span class="n">error</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}</span>
    <span class="k">end</span><span class="p">;</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-12'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-12">#</a>
        </div>
        <p>Write subsequent chunks of data and notify the progress monitor of the size.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">io</span><span class="o">=</span><span class="nv">IO</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="nv">Done</span><span class="p">},</span> <span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">file</span><span class="p">:</span><span class="n">write</span><span class="p">(</span><span class="nv">IO</span><span class="p">,</span> <span class="nv">Data</span><span class="p">),</span>
    <span class="n">file_updated</span><span class="p">(</span><span class="nv">Context</span><span class="nl">#con</span><span class="p">{</span><span class="n">done</span><span class="o">=</span><span class="p">(</span><span class="nv">Done</span> <span class="o">+</span> <span class="nb">size</span><span class="p">(</span><span class="nv">Data</span><span class="p">))});</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-13'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-13">#</a>
        </div>
        <p>Apply the binary key to the data for later use for tracking in <a href="progress.html">progress.erl</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nv">Context</span><span class="p">,</span> <span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">done</span><span class="p">,</span> <span class="nv">Context</span><span class="nl">#con</span><span class="p">{</span><span class="n">key</span><span class="o">=</span><span class="nv">Data</span><span class="p">}};</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-14'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-14">#</a>
        </div>
        <p>Apply the description text to the upload record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(</span><span class="n">description</span><span class="p">,</span> <span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">upload</span><span class="o">=</span><span class="nv">Upload</span><span class="p">},</span> <span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">done</span><span class="p">,</span> <span class="nv">Context</span><span class="nl">#con</span><span class="p">{</span><span class="n">upload</span><span class="o">=</span><span class="nv">Upload</span><span class="nl">#upload</span><span class="p">{</span><span class="n">description</span><span class="o">=</span><span class="nv">Data</span><span class="p">}}};</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-15'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-15">#</a>
        </div>
        <p>Unknown field was received.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body</span><span class="p">(_</span><span class="nv">Unknown</span><span class="p">,</span> <span class="nv">Context</span><span class="p">,</span> <span class="p">_</span><span class="nv">Data</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">done</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-16'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-16">#</a>
        </div>
        <p>End of a boundary received, close any open <code>IO</code> handles, and notify 
the progress monitor that the file has been completed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">body_end</span><span class="p">(</span><span class="nv">Field</span><span class="p">,</span> <span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">io</span><span class="o">=</span><span class="nv">IO</span><span class="p">})</span> <span class="o">-&gt;</span> 
    <span class="k">case</span> <span class="nv">Field</span> <span class="k">of</span> 
        <span class="n">file</span> <span class="o">-&gt;</span>
            <span class="k">case</span> <span class="nv">IO</span> <span class="k">of</span>
                <span class="n">none</span> <span class="o">-&gt;</span> 
                    <span class="n">ok</span><span class="p">;</span>
                <span class="nv">IO</span> <span class="o">-&gt;</span>
                    <span class="n">file_completed</span><span class="p">(</span><span class="nv">Context</span><span class="p">),</span>
                    <span class="nn">file</span><span class="p">:</span><span class="n">close</span><span class="p">(</span><span class="nv">IO</span><span class="p">)</span>
            <span class="k">end</span><span class="p">;</span>
        <span class="nv">Field</span> <span class="o">-&gt;</span> <span class="n">ok</span>
    <span class="k">end</span><span class="p">,</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-17'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-17">#</a>
        </div>
        <p>Helpers for logging and notifying the progress monitor of various events
that only apply to any file inputs from the received form data.                                 <br />
</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">file_started</span><span class="p">(</span><span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">key</span><span class="o">=</span><span class="nv">Key</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="nv">Upload</span><span class="p">})</span> <span class="o">-&gt;</span> 
    <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">~p</span><span class="s"> bytes pending&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Context</span><span class="nl">#con.total</span><span class="p">]),</span>
    <span class="nn">progress</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="n">started</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Upload</span><span class="nl">#upload.id</span><span class="p">}),</span> 
    <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}.</span>

<span class="nf">file_updated</span><span class="p">(</span><span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">key</span><span class="o">=</span><span class="nv">Key</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nv">Total</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="nv">Done</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nv">Percent</span> <span class="o">=</span> <span class="n">percentage</span><span class="p">(</span><span class="nv">Done</span><span class="p">,</span> <span class="nv">Total</span><span class="p">),</span>
    <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">~p</span><span class="s">% of </span><span class="si">~p</span><span class="s"> bytes&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Percent</span><span class="p">,</span> <span class="nv">Context</span><span class="nl">#con.total</span><span class="p">]),</span>
    <span class="nn">progress</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="n">updated</span><span class="p">,</span> <span class="nv">Key</span><span class="p">,</span> <span class="nv">Percent</span><span class="p">}),</span> 
    <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}.</span>

<span class="nf">file_completed</span><span class="p">(</span><span class="nv">Context</span><span class="o">=</span><span class="nl">#con</span><span class="p">{</span><span class="n">key</span><span class="o">=</span><span class="nv">Key</span><span class="p">})</span> <span class="o">-&gt;</span> 
    <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="nv">Key</span><span class="p">,</span> <span class="s">&quot;completed&quot;</span><span class="p">),</span>
    <span class="nn">progress</span><span class="p">:</span><span class="n">update</span><span class="p">({</span><span class="n">completed</span><span class="p">,</span> <span class="nv">Key</span><span class="p">}),</span> 
    <span class="p">{</span><span class="n">file</span><span class="p">,</span> <span class="nv">Context</span><span class="p">}.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-18'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-18">#</a>
        </div>
        <p>Saves the <code>upload</code> record using <a href="datastore.html">datastore.erl</a> and gets the
<code>upload_path</code> to copy the temporary file to.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">save</span><span class="p">(</span><span class="nl">#con</span><span class="p">{</span><span class="n">path</span><span class="o">=</span><span class="nv">Path</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="nv">Upload</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="nv">Path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">~p</span><span class="s"> saving&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Upload</span><span class="p">]),</span>
    <span class="nv">To</span> <span class="o">=</span> <span class="nn">config</span><span class="p">:</span><span class="n">upload_path</span><span class="p">(</span><span class="nn">datastore</span><span class="p">:</span><span class="n">save</span><span class="p">(</span><span class="nv">Upload</span><span class="p">)),</span>
    <span class="n">move</span><span class="p">(</span><span class="nv">Path</span><span class="p">,</span> <span class="nv">To</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-19'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-19">#</a>
        </div>
        <p>Ensures the destination directory exists, copies the file to
its new location, and deletes the temporary file.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">move</span><span class="p">(</span><span class="nv">Path</span><span class="p">,</span> <span class="nv">To</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="nn">filelib</span><span class="p">:</span><span class="n">ensure_dir</span><span class="p">(</span><span class="nv">To</span><span class="p">),</span>
    <span class="p">{</span><span class="n">ok</span><span class="p">,</span> <span class="p">_</span><span class="nv">Size</span><span class="p">}</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="n">copy</span><span class="p">(</span><span class="nv">Path</span><span class="p">,</span> <span class="nv">To</span><span class="p">),</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="nn">file</span><span class="p">:</span><span class="n">delete</span><span class="p">(</span><span class="nv">Path</span><span class="p">),</span>    
    <span class="nn">logger</span><span class="p">:</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Move&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">~s</span><span class="s"> to </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Path</span><span class="p">,</span> <span class="nv">To</span><span class="p">]).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-20'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-20">#</a>
        </div>
        <p>Get the transferred amount of bytes vs the total in a truncated
float to send to the progress monitor. Done in a fairly messy fashion
due to limitations of Erlang's math module.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">percentage</span><span class="p">(</span><span class="nv">Done</span><span class="p">,</span> <span class="nv">Total</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">truncate</span><span class="p">((</span><span class="nv">Done</span> <span class="o">/</span> <span class="nv">Total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">).</span>

<span class="nf">truncate</span><span class="p">(</span><span class="nv">Float</span><span class="p">)</span> <span class="o">-&gt;</span> 
    <span class="p">[</span><span class="nv">Str</span><span class="p">]</span> <span class="o">=</span> <span class="nn">io_lib</span><span class="p">:</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="si">~.2f</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nv">Float</span><span class="p">]),</span>
    <span class="p">{</span><span class="nv">Float1</span><span class="p">,</span> <span class="p">[]}</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">to_float</span><span class="p">(</span><span class="nv">Str</span><span class="p">),</span>
    <span class="nv">Float1</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-21'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-21">#</a>
        </div>
        <p>Create a new context using the request's <code>Content-Length</code> as a guideline
for the number of bytes that will be transferred.
<code>datastore:build/0</code> safely generates a new id for the upload record which is
used to pass the path prematurely to the client.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">new_context</span><span class="p">(</span><span class="nv">Req</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Total</span> <span class="o">=</span> <span class="nb">list_to_integer</span><span class="p">(</span><span class="nv">Req</span><span class="p">:</span><span class="n">get_header_value</span><span class="p">(</span><span class="n">&#39;Content-Length&#39;</span><span class="p">)),</span>
    <span class="nl">#con</span><span class="p">{</span><span class="n">total</span><span class="o">=</span><span class="nv">Total</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="nn">datastore</span><span class="p">:</span><span class="n">build</span><span class="p">()}.</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
