<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>datastore.erl</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>datastore.erl</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-0'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
        <p><code>mnesia</code> wrapper for the <code>upload</code> schema.
Enables basic querying and <code>upload</code> record management functions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="p">-</span><span class="ni">module</span><span class="p">(</span><span class="n">datastore</span><span class="p">).</span>

<span class="p">-</span><span class="ni">export</span><span class="p">([</span><span class="n">start</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">find</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="n">build</span><span class="o">/</span><span class="mi">0</span><span class="p">,</span> <span class="n">save</span><span class="o">/</span><span class="mi">1</span><span class="p">]).</span>

<span class="p">-</span><span class="ni">include_lib</span><span class="p">(</span><span class="s">&quot;stdlib/include/qlc.hrl&quot;</span><span class="p">).</span>
<span class="p">-</span><span class="ni">include</span><span class="p">(</span><span class="s">&quot;records.hrl&quot;</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-1'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
        <h3>Starting:</h3>
<p>Start is called by <code>up</code> during the main otp callback.</p>
<ul>
<li>Create a schema on the current node</li>
<li>Start <code>mnesia</code> application</li>
<li>Create a table for the <code>upload</code> record
All <code>mnesia</code> errors are unhandled as these can be safely called repeatedly.</li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">start</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">mnesia</span><span class="p">:</span><span class="n">create_schema</span><span class="p">([</span><span class="nb">node</span><span class="p">()]),</span>
    <span class="nv">Start</span> <span class="o">=</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">start</span><span class="p">(),</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">record_info</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">id</span><span class="p">)),</span>
    <span class="n">create_table</span><span class="p">(</span><span class="n">upload</span><span class="p">,</span> <span class="n">record_info</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">upload</span><span class="p">)),</span>
    <span class="nv">Start</span><span class="p">.</span>

<span class="c">% No need to stop mnesia, otp and application:stop/1 manage that</span>
<span class="nf">stop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ok</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-2'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
        <p>Find all stored/completed uploads.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">find</span><span class="p">(</span><span class="n">all</span><span class="p">)</span>                    <span class="o">-&gt;</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">dirty_match_object</span><span class="p">(</span><span class="nl">#upload</span><span class="p">{_</span> <span class="o">=</span> <span class="n">&#39;_&#39;</span><span class="p">});</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-3'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
        <p>Perform a keyword search.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">find</span><span class="p">({</span><span class="n">keyword</span><span class="p">,</span> <span class="nv">Keyword</span><span class="p">})</span>     <span class="o">-&gt;</span> <span class="n">execute</span><span class="p">(</span><span class="k">fun</span> <span class="n">search</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">Keyword</span><span class="p">]);</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-4'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
        <p>Read a single row matching <code>Id</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">find</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="k">when</span> <span class="nb">is_integer</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">execute</span><span class="p">(</span><span class="k">fun</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">read</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="p">[{</span><span class="n">upload</span><span class="p">,</span> <span class="nv">Id</span><span class="p">}]);</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-5'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-5">#</a>
        </div>
        <p>Attempt to parse a non-integral <code>Id</code>, returning no rows on failure.
This is handled via a <code>404</code> in <a href="dispatcher.html">dispatcher.erl</a> when no rows are found.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">find</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">case</span> <span class="nn">string</span><span class="p">:</span><span class="n">to_integer</span><span class="p">(</span><span class="nv">Id</span><span class="p">)</span> <span class="k">of</span>
        <span class="p">{</span><span class="nv">I</span><span class="p">,</span> <span class="p">[]}</span> <span class="o">-&gt;</span> <span class="n">find</span><span class="p">(</span><span class="nv">I</span><span class="p">);</span>
        <span class="p">_</span><span class="nv">Else</span> <span class="o">-&gt;</span> <span class="p">[]</span>
    <span class="k">end</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-6'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-6">#</a>
        </div>
        <p>Return a new <code>upload</code> record with it's <code>Id</code> already set, but unsaved.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nl">#upload</span><span class="p">{</span><span class="n">id</span><span class="o">=</span><span class="n">next_upload_id</span><span class="p">(),</span> <span class="n">created</span><span class="o">=</span><span class="nn">erlang</span><span class="p">:</span><span class="n">localtime</span><span class="p">()}.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-7'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-7">#</a>
        </div>
        <p>Save an <code>upload</code> record optionally setting its <code>Id</code> if none is specified.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">save</span><span class="p">(</span><span class="nv">Upload</span><span class="o">=</span><span class="nl">#upload</span><span class="p">{</span><span class="n">id</span><span class="o">=</span><span class="nv">Id</span><span class="p">})</span> <span class="o">-&gt;</span>
    <span class="nv">NewId</span> <span class="o">=</span> <span class="k">case</span> <span class="nv">Id</span> <span class="k">of</span>
                <span class="n">none</span> <span class="o">-&gt;</span> <span class="n">next_upload_id</span><span class="p">();</span>
                <span class="nv">Id</span> <span class="o">-&gt;</span> <span class="nv">Id</span>
            <span class="k">end</span><span class="p">,</span>
    <span class="n">execute</span><span class="p">(</span><span class="k">fun</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">write</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nv">Upload</span><span class="nl">#upload</span><span class="p">{</span><span class="n">id</span><span class="o">=</span><span class="nv">NewId</span><span class="p">}]),</span>
    <span class="nv">Upload</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-8'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-8">#</a>
        </div>
        <p>Safely generate a new id for an upload, using a seperate table to store previous ids
as <code>mnesia</code> has no concept of an auto-incrementing key.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">next_upload_id</span><span class="p">()</span> <span class="o">-&gt;</span>
    <span class="nn">mnesia</span><span class="p">:</span><span class="n">dirty_update_counter</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">upload</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-9'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-9">#</a>
        </div>
        <p>Create a table on the local node, storing a replica on disk.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">create_table</span><span class="p">(</span><span class="nv">Record</span><span class="p">,</span> <span class="nv">Info</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">mnesia</span><span class="p">:</span><span class="n">create_table</span><span class="p">(</span><span class="nv">Record</span><span class="p">,</span> <span class="p">[{</span><span class="n">disc_copies</span><span class="p">,</span> <span class="p">[</span><span class="nb">node</span><span class="p">()]},</span> <span class="p">{</span><span class="n">attributes</span><span class="p">,</span> <span class="nv">Info</span><span class="p">}]).</span>     </pre></div></pre></div>
      </td>
    </tr><tr id='section-10'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-10">#</a>
        </div>
        <p>Execute a <code>Fun</code> inside an <code>mnesia</code> transaction.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">execute</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="p">{</span><span class="n">atomic</span><span class="p">,</span> <span class="nv">Result</span><span class="p">}</span> <span class="o">=</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">transaction</span><span class="p">(</span><span class="nv">Fun</span><span class="p">,</span> <span class="nv">Args</span><span class="p">),</span>
    <span class="nv">Result</span><span class="p">.</span></pre></div></pre></div>
      </td>
    </tr><tr id='section-11'>
      <td class=docs>
        <div class="octowrap">
          <a class="octothorpe" href="#section-11">#</a>
        </div>
        <p>Search using the <code>qlc</code> query interface performing a case-insensitive 
comparison on <code>Keywords</code> from <code>upload.description</code> field.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><div class="highlight"><pre><span class="nf">search</span><span class="p">(</span><span class="nv">Keyword</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nn">qlc</span><span class="p">:</span><span class="n">eval</span><span class="p">(</span><span class="nn">qlc</span><span class="p">:</span><span class="n">q</span><span class="p">([</span><span class="nv">U</span> <span class="p">||</span> <span class="nv">U</span> <span class="o">&lt;-</span> <span class="nn">mnesia</span><span class="p">:</span><span class="n">table</span><span class="p">(</span><span class="n">upload</span><span class="p">),</span> <span class="n">match</span><span class="p">(</span><span class="nv">U</span><span class="p">,</span> <span class="nv">Keyword</span><span class="p">)])).</span>

<span class="nf">match</span><span class="p">(</span><span class="nl">#upload</span><span class="p">{</span><span class="n">description</span><span class="o">=</span><span class="nv">Desc</span><span class="p">},</span> <span class="nv">Keyword</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nv">Left</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">to_lower</span><span class="p">(</span><span class="nv">Desc</span><span class="p">),</span>
    <span class="nv">Right</span> <span class="o">=</span> <span class="nn">string</span><span class="p">:</span><span class="n">to_lower</span><span class="p">(</span><span class="nv">Keyword</span><span class="p">),</span>
    <span class="nn">string</span><span class="p">:</span><span class="n">str</span><span class="p">(</span><span class="nv">Left</span><span class="p">,</span> <span class="nv">Right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">.</span>

</pre></div></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
